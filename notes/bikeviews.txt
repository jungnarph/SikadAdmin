"""
Bikes Views
"""

from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from .models import Bike
from .firebase_service import BikeFirebaseService
from .sync_service import BikeSyncService


@login_required
def bike_list(request):
    """List all bikes from PostgreSQL"""
    bikes = Bike.objects.all().order_by('-created_at')
    
    context = {
        'bikes': bikes,
        'total_count': bikes.count(),
        'available_count': bikes.filter(status='AVAILABLE').count(),
        'in_use_count': bikes.filter(status='IN_USE').count(),
        'maintenance_count': bikes.filter(status='MAINTENANCE').count(),
    }
    
    return render(request, 'bikes/bike_list.html', context)


@login_required
def bike_detail(request, bike_id):
    """View bike details from Firebase"""
    firebase_service = BikeFirebaseService()
    bike_data = firebase_service.get_bike(bike_id)
    
    if not bike_data:
        messages.error(request, f'Bike {bike_id} not found in Firebase')
        return redirect('bikes:bike_list')
    
    # Get location history
    location_history = firebase_service.get_location_history(bike_id, limit=50)
    
    # Get PostgreSQL data if exists
    try:
        pg_bike = Bike.objects.get(firebase_id=bike_id)
    except Bike.DoesNotExist:
        pg_bike = None
    
    context = {
        'bike': bike_data,
        'pg_bike': pg_bike,
        'location_history': location_history,
    }
    
    return render(request, 'bikes/bike_detail.html', context)


@login_required
def sync_bike(request, bike_id):
    """Sync a single bike from Firebase to PostgreSQL"""
    sync_service = BikeSyncService()
    success = sync_service.sync_single_bike(bike_id)
    
    if success:
        messages.success(request, f'Bike {bike_id} synced successfully')
    else:
        messages.error(request, f'Failed to sync bike {bike_id}')
    
    return redirect('bikes:bike_detail', bike_id=bike_id)


@login_required
def sync_all_bikes(request):
    """Sync all bikes from Firebase to PostgreSQL"""
    sync_service = BikeSyncService()
    stats = sync_service.sync_all_bikes()
    
    messages.success(
        request, 
        f'Synced {stats["total"]} bikes: {stats["created"]} created, {stats["updated"]} updated'
    )
    
    return redirect('bikes:bike_list')