{% extends 'base/base.html' %}

{% block title %}Live Bike Map - Sikad Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #liveMap {
        height: 57vh;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-width: 250px;
    }
    
    .bike-marker {
        background: transparent;
        border: none;
    }
    
    .realtime-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #28a745;
        animation: pulse 2s infinite;
        margin-right: 5px;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    
    .legend {
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 8px;
    }
    
    .control-section {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .control-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .control-section h6 {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i class="fas fa-map-marked-alt"></i> Live Bike Map
        <span class="realtime-indicator"></span>
        <small class="text-muted" style="font-size: 0.5em;">Real-time</small>
    </h1>
    <p class="text-muted">Real-time location of all bikes and active geofence zones</p>
</div>

<!-- Statistics Bar -->
<div class="row mb-3">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body py-2">
                <small class="text-muted">Total on Map</small>
                <h4 class="mb-0" id="totalBikes">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body py-2">
                <small class="text-success">Available</small>
                <h4 class="mb-0 text-success" id="availableBikes">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body py-2">
                <small class="text-primary">In Use</small>
                <h4 class="mb-0 text-primary" id="inUseBikes">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body py-2">
                <small class="text-danger">Offline</small>
                <h4 class="mb-0 text-danger" id="offlineBikes">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body py-2">
                <small class="text-muted">Last Update</small>
                <h6 class="mb-0" id="lastUpdate">--:--:--</h6>
            </div>
        </div>
    </div>
</div>

<!-- Map Container -->
<div class="card">
    <div class="card-body position-relative">
        <div id="liveMap"></div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <div class="control-section">
                <h6><i class="fas fa-filter"></i> Filter Bikes</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showAvailable" checked>
                    <label class="form-check-label" for="showAvailable">
                        <span style="color: #28a745;">‚óè</span> Available
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showInUse" checked>
                    <label class="form-check-label" for="showInUse">
                        <span style="color: #007bff;">‚óè</span> In Use
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showOffline" checked>
                    <label class="form-check-label" for="showOffline">
                        <span style="color: #dc3545;">‚óè</span> Offline
                    </label>
                </div>
            </div>
            
            <div class="control-section">
                <h6><i class="fas fa-layer-group"></i> Zones</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showZones" checked>
                    <label class="form-check-label" for="showZones">
                        Show Geofence Zones
                    </label>
                </div>
            </div>
            
            <button class="btn btn-sm btn-outline-primary w-100" onclick="centerMap()">
                <i class="fas fa-crosshairs"></i> Center Map
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase Realtime Database SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {{ firebase_config|safe }};
    
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const database = firebase.database();
    
    // Initialize map centered on Philippines (Bulacan)
    const map = L.map('liveMap').setView([14.8433, 120.8111], 13);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Store markers and polygons
    let bikeMarkers = {};
    let zonePolygons = {};
    let realtimeListeners = {};
    
    // Initial bike data from Django (fallback)
    const initialBikes = {{ bikes_json|safe }};
    
    // Zone data from Django
    const zones = {{ zones_json|safe }};
    
    // Color mapping for bike status
    const statusColors = {
        'AVAILABLE': '#28a745',
        'IN_USE': '#007bff',
        'OFFLINE': '#dc3545'
    };
    
    // Statistics object
    let stats = {
        total: 0,
        available: 0,
        inUse: 0,
        offline: 0
    };
    
    // Function to create bike marker
    function createBikeMarker(bike) {
        const color = statusColors[bike.status] || '#6c757d';
        
        const icon = L.divIcon({
            html: `<i class="fas fa-bicycle fa-2x" style="color: ${color};"></i>`,
            className: 'bike-marker',
            iconSize: [30, 30]
        });
        
        const marker = L.marker([bike.latitude, bike.longitude], {icon: icon})
            .bindPopup(`
                <div style="min-width: 200px;">
                    <h6><strong>${bike.bike_id}</strong></h6>
                    <p class="mb-1"><small><strong>Model:</strong> ${bike.bike_model || 'N/A'}</small></p>
                    <p class="mb-1"><small><strong>Type:</strong> ${bike.bike_type || 'N/A'}</small></p>
                    <p class="mb-1"><small><strong>Status:</strong> <span class="badge" style="background: ${color};">${bike.status}</span></small></p>
                    ${bike.current_zone_id ? `<p class="mb-1"><small><strong>Zone:</strong> ${bike.current_zone_id}</small></p>` : ''}
                    ${bike.speed ? `<p class="mb-1"><small><strong>Speed:</strong> ${bike.speed} km/h</small></p>` : ''}
                    <p class="mb-1"><small><strong>Last Update:</strong> ${new Date().toLocaleTimeString()}</small></p>
                    <a href="/bikes/${bike.bike_id}/" class="btn btn-sm btn-primary mt-2 w-100">View Details</a>
                </div>
            `);
        
        return marker;
    }
    
    // Function to update bike marker position and status
    function updateBikeMarker(bikeId, bikeData) {
        // Remove old marker if exists
        if (bikeMarkers[bikeId]) {
            bikeMarkers[bikeId].marker.remove();
        }
        
        // Create and add new marker
        const marker = createBikeMarker(bikeData);
        bikeMarkers[bikeId] = {
            marker: marker,
            status: bikeData.status,
            data: bikeData
        };
        
        // Check if marker should be visible based on filters
        if (shouldShowBike(bikeData.status)) {
            marker.addTo(map);
        }
        
        updateStatistics();
    }
    
    // Function to remove bike marker
    function removeBikeMarker(bikeId) {
        if (bikeMarkers[bikeId]) {
            bikeMarkers[bikeId].marker.remove();
            delete bikeMarkers[bikeId];
            updateStatistics();
        }
    }
    
    // Function to check if bike should be shown based on filters
    function shouldShowBike(status) {
        const showAvailable = document.getElementById('showAvailable').checked;
        const showInUse = document.getElementById('showInUse').checked;
        const showOffline = document.getElementById('showOffline').checked;
        
        return (
            (status === 'AVAILABLE' && showAvailable) ||
            (status === 'IN_USE' && showInUse) ||
            (status === 'OFFLINE' && showOffline)
        );
    }
    
    // Function to update statistics
    function updateStatistics() {
        stats = {
            total: 0,
            available: 0,
            inUse: 0,
            offline: 0
        };
        
        Object.values(bikeMarkers).forEach(bikeData => {
            stats.total++;
            if (bikeData.status === 'AVAILABLE') stats.available++;
            else if (bikeData.status === 'IN_USE') stats.inUse++;
            else if (bikeData.status === 'OFFLINE') stats.offline++;
        });
        
        document.getElementById('totalBikes').textContent = stats.total;
        document.getElementById('availableBikes').textContent = stats.available;
        document.getElementById('inUseBikes').textContent = stats.inUse;
        document.getElementById('offlineBikes').textContent = stats.offline;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
    
    // Function to setup real-time listeners for bikes
    function setupRealtimeListeners() {
        const bikesRef = database.ref('bikes');
        
        // Listen for new bikes
        bikesRef.on('child_added', (snapshot) => {
            const bikeId = snapshot.key;
            const bikeData = snapshot.val();
            
            if (bikeData && bikeData.latitude && bikeData.longitude) {
                const bike = {
                    bike_id: bikeId,
                    bike_model: bikeData.bike_model || 'Unknown',
                    bike_type: bikeData.bike_type || 'REGULAR',
                    status: bikeData.status || 'OFFLINE',
                    latitude: bikeData.latitude,
                    longitude: bikeData.longitude,
                    current_zone_id: bikeData.current_zone_id || '',
                    speed: bikeData.speed || null
                };
                
                updateBikeMarker(bikeId, bike);
            }
        });
        
        // Listen for bike updates
        bikesRef.on('child_changed', (snapshot) => {
            const bikeId = snapshot.key;
            const bikeData = snapshot.val();
            
            if (bikeData && bikeData.latitude && bikeData.longitude) {
                const bike = {
                    bike_id: bikeId,
                    bike_model: bikeData.bike_model || 'Unknown',
                    bike_type: bikeData.bike_type || 'REGULAR',
                    status: bikeData.status || 'OFFLINE',
                    latitude: bikeData.latitude,
                    longitude: bikeData.longitude,
                    current_zone_id: bikeData.current_zone_id || '',
                    speed: bikeData.speed || null
                };
                
                updateBikeMarker(bikeId, bike);
            }
        });
        
        // Listen for bike removals
        bikesRef.on('child_removed', (snapshot) => {
            const bikeId = snapshot.key;
            removeBikeMarker(bikeId);
        });
        
        console.log('‚úÖ Real-time listeners setup for bikes');
    }
    
    // Function to create zone polygon
    function createZonePolygon(zone) {
        if (!zone.polygon_points || zone.polygon_points.length < 3) {
            return null;
        }
        
        const latLngs = zone.polygon_points.map(p => [p.latitude, p.longitude]);
        
        const polygon = L.polygon(latLngs, {
            color: zone.color_code,
            fillColor: zone.color_code,
            fillOpacity: 0.2,
            weight: 2,
            opacity: 0.8
        });
        
        polygon.bindPopup(`
            <div style="min-width: 200px;">
                <h6><strong>${zone.name}</strong></h6>
                <p class="mb-1"><small><strong>Zone ID:</strong> ${zone.zone_id}</small></p>
                <p class="mb-1"><small><strong>Points:</strong> ${zone.polygon_points.length} vertices</small></p>
                <p class="mb-1"><small><strong>Status:</strong> <span class="badge bg-success">Active</span></small></p>
                ${zone.description ? `<p class="mb-1"><small>${zone.description}</small></p>` : ''}
                <a href="/geofencing/${zone.zone_id}/" class="btn btn-sm btn-info mt-2 w-100">View Zone</a>
            </div>
        `);
        
        return polygon;
    }
    
    // Function to load zones on map
    function loadZones() {
        zones.forEach(zone => {
            const polygon = createZonePolygon(zone);
            if (polygon) {
                zonePolygons[zone.zone_id] = {
                    polygon: polygon,
                    zone: zone
                };
                polygon.addTo(map);
            }
        });
        
        console.log(`Loaded ${Object.keys(zonePolygons).length} active zones`);
    }
    
    // Function to load initial bikes (fallback)
    function loadInitialBikes() {
        initialBikes.forEach(bike => {
            if (bike.latitude && bike.longitude) {
                updateBikeMarker(bike.bike_id, bike);
            }
        });
        
        console.log(`Loaded ${Object.keys(bikeMarkers).length} initial bikes`);
    }
    
    // Filter bikes based on checkboxes
    function filterBikes() {
        Object.entries(bikeMarkers).forEach(([bikeId, data]) => {
            if (shouldShowBike(data.status)) {
                data.marker.addTo(map);
            } else {
                data.marker.remove();
            }
        });
    }
    
    // Toggle zones visibility
    function toggleZones() {
        const showZones = document.getElementById('showZones').checked;
        
        Object.values(zonePolygons).forEach(zoneData => {
            if (zoneData.polygon) {
                if (showZones) {
                    zoneData.polygon.addTo(map);
                } else {
                    zoneData.polygon.remove();
                }
            }
        });
    }
    
    // Center map to show all bikes
    function centerMap() {
        const allLayers = [
            ...Object.values(bikeMarkers).map(b => b.marker),
            ...Object.values(zonePolygons).map(z => z.polygon).filter(p => p !== null)
        ];
        
        if (allLayers.length > 0) {
            const group = L.featureGroup(allLayers);
            map.fitBounds(group.getBounds().pad(0.1));
        } else {
            // Default to Bulacan if no markers
            map.setView([14.8433, 120.8111], 13);
        }
    }
    
    // Add event listeners to checkboxes
    document.getElementById('showAvailable').addEventListener('change', filterBikes);
    document.getElementById('showInUse').addEventListener('change', filterBikes);
    document.getElementById('showOffline').addEventListener('change', filterBikes);
    document.getElementById('showZones').addEventListener('change', toggleZones);
    
    // Initialize the map
    function initializeMap() {
        console.log('üó∫Ô∏è Initializing map...');
        
        // Load zones first (background layer)
        loadZones();
        
        // Load initial bikes (fallback data)
        loadInitialBikes();
        
        // Setup real-time listeners
        setupRealtimeListeners();
        
        // Center map after a short delay
        setTimeout(centerMap, 1000);
        
        console.log('‚úÖ Map initialized');
    }
    
    // Start when page loads
    window.addEventListener('load', initializeMap);
    
    // Cleanup listeners on page unload
    window.addEventListener('beforeunload', () => {
        database.ref('bikes').off();
    });
</script>
{% endblock %}